generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                  String                 @id @default(uuid())
  email               String                 @unique
  passwordHash        String                 @map("password_hash")
  status              AccountStatus          @default("ACTIVE")
  legalName           String?                @map("legal_name")
  recoveryEmail       String?                @map("recovery_email")
  recoveryPhone       String?                @map("recovery_phone")
  preferredTimezone   String?                @map("preferred_timezone")
  preferredLocale     String?                @map("preferred_locale")
  createdAt           DateTime               @default(now()) @map("created_at")
  updatedAt           DateTime               @updatedAt @map("updated_at")
  passwordResetTokens PasswordResetToken[]
  sessions            Session[]
  ownedWorkspaces     Workspace[]            @relation("WorkspaceOwner")
  joinRequests        WorkspaceJoinRequest[]
  memberships         WorkspaceMembership[]
}

model Session {
  id            String    @id @default(uuid())
  accountId     String    @map("account_id")
  expiresAt     DateTime  @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason")
  account       Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  accountId String    @map("account_id")
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  account   Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model Workspace {
  id              String                 @id @default(uuid())
  name            String
  slug            String                 @unique
  description     String?
  coverImage      String?                @map("cover_image")
  defaultLocale   String                 @default("en") @map("default_locale")
  defaultTimezone String                 @default("UTC") @map("default_timezone")
  visibility      WorkspaceVisibility    @default("private")
  ownerAccountId  String                 @map("owner_account_id")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  deletedAt       DateTime?              @map("deleted_at")
  allowedDomains  Json?                  @map("allowed_domains")
  auditLogs       AuditLog[]
  documents       Document[]
  exportJobs      ExportJob[]
  folders         Folder[]
  owner           Account                @relation("WorkspaceOwner", fields: [ownerAccountId], references: [id], onDelete: Cascade)
  invitations     WorkspaceInvitation[]
  joinRequests    WorkspaceJoinRequest[]
  memberships     WorkspaceMembership[]
}

model WorkspaceMembership {
  id                  String                    @id @default(uuid())
  workspaceId         String                    @map("workspace_id")
  accountId           String                    @map("account_id")
  role                WorkspaceMembershipRole   @default("member")
  status              WorkspaceMembershipStatus @default("active")
  displayName         String?                   @map("display_name")
  avatarUrl           String?                   @map("avatar_url")
  timezone            String?                   @map("timezone")
  preferredLocale     String?                   @map("preferred_locale")
  notifications       Json?                     @map("notification_settings")
  createdAt           DateTime                  @default(now()) @map("created_at")
  updatedAt           DateTime                  @updatedAt @map("updated_at")
  ownedDocuments      Document[]                @relation("DocumentOwner")
  documentPermissions DocumentPermission[]      @relation("DocumentPermissionMembership")
  revisionHistory     DocumentRevision[]        @relation("RevisionAuthor")
  createdShareLinks   DocumentShareLink[]
  account             Account                   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  workspace           Workspace                 @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, accountId])
}

model WorkspaceInvitation {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  email       String
  tokenHash   String    @unique @map("token_hash")
  status      String    @default("pending")
  invitedBy   String    @map("invited_by")
  expiresAt   DateTime  @map("expires_at")
  resentCount Int       @default(0) @map("resent_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model WorkspaceJoinRequest {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  accountId   String    @map("account_id")
  status      String    @default("pending")
  message     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Folder {
  id               String      @id @default(uuid())
  workspaceId      String      @map("workspace_id")
  parentId         String?     @map("parent_id")
  name             String
  pathCache        String      @map("path_cache")
  sortOrder        Int         @default(0) @map("sort_order")
  deletedAt        DateTime?   @map("deleted_at")
  deletedBy        String?     @map("deleted_by")
  originalParentId String?     @map("original_parent_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  isImportant      Boolean     @default(false) @map("is_important")
  documents        Document[]
  parent           Folder?     @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         Folder[]    @relation("FolderHierarchy")
  workspace        Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tags             FolderTag[]

  @@index([workspaceId])
  @@index([workspaceId, parentId])
}

model Document {
  id                        String                  @id @default(uuid())
  workspaceId               String                  @map("workspace_id")
  folderId                  String?                 @map("folder_id")
  ownerMembershipId         String                  @map("owner_membership_id")
  title                     String
  slug                      String
  status                    DocumentStatus          @default("draft")
  visibility                DocumentVisibility      @default("private")
  summary                   String?                 @map("summary")
  contentSize               Int                     @default(0) @map("content_size")
  sortOrder                 Int                     @default(0) @map("sort_order")
  workspaceDefaultAccess    DocumentWorkspaceAccess @default("none") @map("workspace_default_access")
  workspaceEditorAdminsOnly Boolean                 @default(false) @map("workspace_editor_admins_only")
  deletedAt                 DateTime?               @map("deleted_at")
  deletedBy                 String?                 @map("deleted_by")
  originalFolderId          String?                 @map("original_folder_id")
  createdAt                 DateTime                @default(now()) @map("created_at")
  updatedAt                 DateTime                @updatedAt @map("updated_at")
  isImportant               Boolean                 @default(false) @map("is_important")
  ownerMembership           WorkspaceMembership     @relation("DocumentOwner", fields: [ownerMembershipId], references: [id])
  folder                    Folder?                 @relation(fields: [folderId], references: [id])
  workspace                 Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  permissions               DocumentPermission[]
  revisions                 DocumentRevision[]
  shareLinks                DocumentShareLink[]
  tags                      DocumentTag[]
  exportJobs                ExportJob[]

  @@unique([workspaceId, slug])
  @@index([workspaceId, folderId])
  @@index([ownerMembershipId])
}

model ExportJob {
  id           String          @id @default(uuid())
  workspaceId  String          @map("workspace_id")
  documentId   String?         @map("document_id")
  format       String
  status       ExportJobStatus @default("pending")
  resultUrl    String?         @map("result_url")
  errorMessage String?         @map("error_message")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  retryCount   Int             @default(0) @map("retry_count")
  document     Document?       @relation(fields: [documentId], references: [id])
  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model DocumentTag {
  id         String   @id @default(uuid())
  documentId String   @map("document_id")
  name       String
  createdAt  DateTime @default(now()) @map("created_at")
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, name])
  @@index([documentId])
}

model FolderTag {
  id        String   @id @default(uuid())
  folderId  String   @map("folder_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  folder    Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@unique([folderId, name])
  @@index([folderId])
}

model DocumentRevision {
  id                    String              @id @default(uuid())
  documentId            String              @map("document_id")
  version               Int
  content               Json                @map("content")
  summary               String?             @map("summary")
  createdByMembershipId String              @map("created_by_membership_id")
  createdAt             DateTime            @default(now()) @map("created_at")
  contentSize           Int                 @default(0) @map("content_size")
  createdByMembership   WorkspaceMembership @relation("RevisionAuthor", fields: [createdByMembershipId], references: [id])
  document              Document            @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
}

model DocumentPermission {
  id            String                          @id @default(uuid())
  documentId    String                          @map("document_id")
  principalType DocumentPermissionPrincipalType @map("principal_type")
  principalId   String                          @map("principal_id")
  membershipId  String?                         @map("membership_id")
  role          DocumentPermissionRole
  createdAt     DateTime                        @default(now()) @map("created_at")
  updatedAt     DateTime                        @updatedAt @map("updated_at")
  membership    WorkspaceMembership?            @relation("DocumentPermissionMembership", fields: [membershipId], references: [id], onDelete: Cascade)
  document      Document                        @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, principalType, principalId])
  @@index([membershipId])
}

model DocumentShareLink {
  id                    String                     @id @default(uuid())
  documentId            String                     @map("document_id")
  token                 String                     @unique
  accessLevel           DocumentShareLinkAccess    @map("access_level")
  passwordHash          String?                    @map("password_hash")
  expiresAt             DateTime?                  @map("expires_at")
  revokedAt             DateTime?                  @map("revoked_at")
  createdByMembershipId String                     @map("created_by_membership_id")
  allowExternalEdit     Boolean                    @default(false) @map("allow_external_edit")
  createdAt             DateTime                   @default(now()) @map("created_at")
  createdByMembership   WorkspaceMembership        @relation(fields: [createdByMembershipId], references: [id], onDelete: Cascade)
  document              Document                   @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sessions              DocumentShareLinkSession[]

  @@index([documentId])
}

model ExternalCollaborator {
  id          String                     @id @default(uuid())
  email       String                     @unique
  displayName String?                    @map("display_name")
  status      ExternalCollaboratorStatus @default("active")
  createdAt   DateTime                   @default(now()) @map("created_at")
  updatedAt   DateTime                   @updatedAt @map("updated_at")
  sessions    DocumentShareLinkSession[]
}

model DocumentShareLinkSession {
  id             String               @id @default(uuid())
  shareLinkId    String               @map("share_link_id")
  collaboratorId String               @map("collaborator_id")
  tokenHash      String               @unique @map("token_hash")
  expiresAt      DateTime             @map("expires_at")
  revokedAt      DateTime?            @map("revoked_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  collaborator   ExternalCollaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  shareLink      DocumentShareLink    @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)

  @@index([shareLinkId])
  @@index([collaboratorId])
}

model AuditLog {
  id                  String         @id @default(uuid())
  workspaceId         String         @map("workspace_id")
  actorType           AuditActorType @map("actor_type")
  actorMembershipId   String?        @map("actor_membership_id")
  actorCollaboratorId String?        @map("actor_collaborator_id")
  action              String
  entityType          String         @map("entity_type")
  entityId            String?        @map("entity_id")
  metadata            Json?          @map("metadata")
  createdAt           DateTime       @default(now()) @map("created_at")
  workspace           Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@index([actorMembershipId])
  @@index([actorCollaboratorId])
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum WorkspaceVisibility {
  private
  listed
  public
}

enum WorkspaceMembershipRole {
  owner
  admin
  member
}

enum WorkspaceMembershipStatus {
  active
  invited
  pending
  removed
}

enum DocumentStatus {
  draft
  published
  archived
}

enum DocumentVisibility {
  private
  workspace
  shared
  public
}

enum DocumentWorkspaceAccess {
  none
  viewer
  commenter
  editor
}

enum DocumentPermissionRole {
  viewer
  commenter
  editor
}

enum DocumentPermissionPrincipalType {
  workspace
  membership
  account
  share_link
}

enum DocumentShareLinkAccess {
  viewer
  commenter
}

enum ExternalCollaboratorStatus {
  active
  suspended
}

enum AuditActorType {
  membership
  external
}

enum ExportJobStatus {
  pending
  processing
  completed
  failed
  cancelled
}


